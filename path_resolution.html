<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Path resolution - Lockjaw User Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lockjaw User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="path-resolution"><a class="header" href="#path-resolution">Path resolution</a></h1>
<p>Lockjaw need to know the fully qualified path of a type, so they can be compared against each other.</p>
<p>In Rust, all a <code>proc_macro</code> can see is tokens, which is too early to resolve the type path. When a
<code>Foo</code> identifier is encountered, it is difficult for the macro to understand whether it is a type
declared in the local module, or a type from somewhere else brought in by a <code>use</code> declaration. Rust
don't even tell the macro what the local module is.</p>
<h2 id="base-mod-of-the-file"><a class="header" href="#base-mod-of-the-file">Base <code>mod</code> of the file</a></h2>
<p>The first problem is the <code>proc_macro</code> doesn't even know where the source being compiled is at. The
<a href="https://doc.rust-lang.org/std/macro.file.html"><code>file!()</code></a>
and <a href="https://doc.rust-lang.org/std/macro.module_path.html"><code>module_path!()</code></a> would be a perfect
solution to this, but <a href="https://github.com/rust-lang/rfcs/pull/2320">eager macro expansion</a> is
required for a <code>proc_macro</code> to be able to utilize it.</p>
<p><a href="https://docs.rs/proc-macro2/1.0.28/proc_macro2/struct.Span.html#method.source_file">proc_macro2::Span::source_file()</a>
also exists, but it is nightly feature and requires <code>procmacro2_semver_exempt</code> which is contagious.</p>
<p>Since the with <a href="cross_macro_communication.html">cross macro communication</a> hacks the user only need to
do this once per file, we've decided to let the user pass the current path with
the <a href="https://docs.rs/lockjaw/latest/lockjaw/macro.prologue.html"><code>prologue!()</code></a> macro. We will need
to parse the whole file later anyway, so we take the file name and derive the <code>mod</code> path from it.</p>
<p>To make sure the <code>prologue!()</code> macro is called in every file, it declares a hidden symbol locally
which all other Lockjaw <code>proc_macro</code> will try to use, so if the <code>prolouge!()</code> is missing compilation
will fail. In later steps we also verify <code>prologue!()</code> is the first Lockjaw macro called in the
file, as the current file info is stored in global memory and must be reset in each file.</p>
<p><code>prolouge!()</code> also generates a test to make sure the path passed in matches what <code>file!()</code> would
give. However using the wrong path will usually cause Lockjaw to fail miserably since all type info
are messed up, and the test will not even be run, which makes it not too useful.</p>
<h2 id="mod-structure-and-use-declarations"><a class="header" href="#mod-structure-and-use-declarations"><code>mod</code> structure and <code>use</code> declarations</a></h2>
<p>A file can still contain nested <code>mod</code> in it, each importing more symbols with the <code>use</code> declaration.
For a given token, lockjaw needs to know which <code>mod</code> it is in, and what symbols are brought into
that scope. This requires parsing the whole file, so we can keep what the span of each <code>mod</code> is and
what <code>use</code> are inside it.</p>
<p><a href="https://docs.rs/syn/1.0.75/syn/fn.parse_file.html"><code>syn::parse_file()</code></a> sounds like a good fit for
this, however the tokens it produces does not record
proper <a href="https://docs.rs/proc-macro2/1.0.28/proc_macro2/struct.Span.html">spans</a>, so we cannot use it
to find the position of <code>mod</code>.</p>
<p>Lockjaw handles this by using another AST
parser (<a href="https://crates.io/crates/tree-sitter">tree_sitter</a>) to parse the file.</p>
<h2 id="finding-which-mod-a-token-is-in"><a class="header" href="#finding-which-mod-a-token-is-in">Finding which <code>mod</code> a token is in</a></h2>
<p>Position info of a token is encoded in
the <a href="https://docs.rs/proc-macro2/1.0.28/proc_macro2/struct.Span.html">span</a> object, but currently it
is opaque. Lockjaw forcefully extract the data from
span's <a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html"><code>Debug</code></a> representation, which contains
the token's byte range. No need to say this is an awful thing to do.</p>
<p>Once the byte position is know, it can be used to find the deepest enclosing <code>mod</code>.</p>
<h2 id="handling-file-mod"><a class="header" href="#handling-file-mod">Handling file <code>mod</code></a></h2>
<p>Rust currently handles file <code>mod</code> as includes internally. It inserts the content of the file
directly into the token stream, and ends up in a giant stream for the whole crate. The consequence
of this is the byte position the <code>proc_marco</code> token actually have is shifted around by inserted
files, and will not match its byte position inside the file the 3p AST parser sees.</p>
<p>Fortunately the Lockjaw <code>proc_macro</code> has the span of the <code>prologue!()</code> macro itself, and it knows
the macro must appear only once inside the file. Lockjaw is able to inspect the AST to find the file
position of the <code>prologue!()</code> macro, and calculate the offset between file position and token
position.</p>
<p>One of the effect is Lockjaw has to ban file <code>mod</code> that appears after <code>prologue!()</code>, as it will
invalidate the offset. Theoretically Lockjaw can recursively calculate the size of the file <code>mod</code>,
but limiting the position of file <code>mod</code> does not seem too bad.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="caveats.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="cross_macro_communication.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="caveats.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="cross_macro_communication.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
